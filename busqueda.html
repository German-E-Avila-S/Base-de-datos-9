<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>B√∫squeda de Usuarios</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

</head>

<body class="bg-light">

  <div class="container py-5">

    <h1 class="text-center mb-4">Buscar Usuarios</h1>

    <!-- üîç Input de b√∫squeda -->
    <div class="d-flex justify-content-center mb-4">
      <input type="text" id="busqueda" class="form-control w-50 shadow-sm"
        placeholder="Escribe el nombre del usuario...">
    </div>

    <!-- üìã Tabla de usuarios -->
    <div class="table-responsive shadow-sm">
      <table class="table table-striped table-hover align-middle" id="tablaUsuarios">
        <thead class="table-dark">
          <tr>
            <th>Nombre de Usuario</th>
            <th>Tipo de Usuario</th>
            <th class="text-center">Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

  </div>

  <script>
    const inputBusqueda = document.getElementById('busqueda');
    const tablaUsuarios = document.querySelector('#tablaUsuarios tbody');

    // üîç B√∫squeda en tiempo real
    inputBusqueda.addEventListener('input', async () => {
      const query = inputBusqueda.value.trim();

      const res = await fetch(`/buscar?query=${encodeURIComponent(query)}`);
      const data = await res.json();

      tablaUsuarios.innerHTML = '';

      if (data.length === 0) {
        tablaUsuarios.innerHTML =
          '<tr><td colspan="3" class="text-center text-muted py-3">No se encontraron usuarios.</td></tr>';
        return;
      }

      data.forEach(user => {
        tablaUsuarios.innerHTML += `
        <tr>
          <td>${user.nombre_usuario}</td>
          <td>${user.tipo_usuario || 'Sin rol'}</td>

          <td class="text-center">

            <div class="d-flex justify-content-center flex-wrap gap-3">

              <!-- üóëÔ∏è Eliminar -->
              <form action="/eliminar-usuario" method="POST"
                    onsubmit="return validarAccion('eliminar', ${user.id})"
                    class="d-flex flex-column align-items-center">

                <input type="hidden" name="id" value="${user.id}">

                <div class="form-check mb-1">
                  <input type="checkbox" class="form-check-input" id="check-eliminar-${user.id}">
                  <label class="form-check-label small">Confirmar</label>
                </div>

                <button type="submit" class="btn btn-danger btn-sm">
                  Eliminar
                </button>
              </form>

              <!-- ‚úèÔ∏è Editar -->
              <form action="/editar-usuario" method="POST"
                    onsubmit="return validarAccion('editar', ${user.id})"
                    class="d-flex flex-column gap-2 align-items-center">

                <input type="hidden" name="id" value="${user.id}">

                <div class="d-flex gap-2">

                  <div>
                    <label class="form-label small">Nuevo nombre</label>
                    <input type="text" name="nombre_usuario" class="form-control form-control-sm"
                           value="${user.nombre_usuario}" required>
                  </div>

                  <div>
                    <label class="form-label small">Nuevo tipo</label>
                    <select name="tipo_usuario" class="form-select form-select-sm" required>
                      <option value="admin" ${user.tipo_usuario === 'admin' ? 'selected' : ''}>admin</option>
                      <option value="medico" ${user.tipo_usuario === 'medico' ? 'selected' : ''}>medico</option>
                      <option value="Paciente" ${user.tipo_usuario === 'Paciente' ? 'selected' : ''}>Paciente</option>
                    </select>
                  </div>

                </div>

                <div class="form-check">
                  <input type="checkbox" class="form-check-input" id="check-editar-${user.id}">
                  <label class="form-check-label small">Confirmar</label>
                </div>

                <button type="submit" class="btn btn-warning btn-sm text-white">
                  Editar
                </button>

              </form>

            </div>

          </td>
        </tr>
      `;
      });

    });

    // ‚ö†Ô∏è Validaci√≥n de confirmaci√≥n
    function validarAccion(tipo, id) {
      const checkbox = document.getElementById(`check-${tipo}-${id}`);
      if (!checkbox || !checkbox.checked) {
        alert(`Debes marcar la casilla antes de ${tipo === 'eliminar' ? 'eliminar' : 'editar'} el usuario.`);
        return false;
      }

      return confirm(`¬øSeguro que deseas ${tipo === 'eliminar' ? 'eliminar' : 'editar'} este usuario?`);
    }
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
